(()=>{"use strict";window.util={PIN_WIDTH:65,PIN_HEIGTH_DISABLE:33,PIN_HEIGTH_ACTIVE:84,ESC_KEY_CODE:27,ENTER_KEY_CODE:13,LEFT_BUTTON_MOUSE_DOWN:0},window.backend={load:function(e,t){const n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(function(){200===n.status?e(n.response):(t("Статус ответа: "+n.status+" "+n.statusText),window.filter.hideFormIfError())})),n.addEventListener("error",(function(){t("Произошла ошибка соединения"),window.filter.hideFormIfError()})),n.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+n.timeout+" мс"),window.filter.hideFormIfError()})),n.timeout=1e4,n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()},upload:function(e,t,n){const o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(function(){switch(o.status){case 200:t(o.response);break;case 400:n("Произошла ошибка сервера: неверный запрос");break;case 401:n("Произошла ошибка сервера: пользователь не авторизован");break;case 404:n("Произошла ошибка сервера: запрашиваемый ресурс не найден");break;case 500:n("Произошла внутренняя ошибка сервера");break;default:n("Произошла ошибка сервера: "+o.status+" "+o.statusText)}})),o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(e)}},(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins"),n=e.querySelector(".map__pin--main"),o=0-window.util.PIN_WIDTH/2,r=121-window.util.PIN_HEIGTH_DISABLE,i=t.clientWidth-Math.floor(window.util.PIN_WIDTH/2),c=621-window.util.PIN_HEIGTH_DISABLE;n.addEventListener("mousedown",(function(e){e.preventDefault();let t={x:e.clientX,y:e.clientY};const u=function(e){e.preventDefault();let u=t.x-e.clientX,d=t.y-e.clientY;t={x:e.clientX,y:e.clientY};let a={x:n.offsetLeft-u,y:n.offsetTop-d};var s;(s=a).x<=o&&(s.x=o),s.x>=i&&(s.x=i),s.y<=r&&(s.y=r),s.y>=c&&(s.y=c),n.style.top=a.y+"px",n.style.left=a.x+"px",window.map.getActive(),window.main.getActivePages()},d=function(e){e.preventDefault(),e.button===window.util.LEFT_BUTTON_MOUSE_DOWN&&(window.main.getActivePages(),window.map.getActive(),document.removeEventListener("mousemove",u),document.removeEventListener("mouseup",d))};document.addEventListener("mousemove",u),document.addEventListener("mouseup",d)}));const u=function(e){e.keyCode===window.util.ENTER_KEY_CODE&&(window.main.getActivePages(),window.map.getActive(),document.removeEventListener("keydown",u))};n.addEventListener("keydown",u)})(),window.debounce={shake:function(e){let t=null;return function(...n){t&&clearTimeout(t),t=setTimeout((()=>{e.call(null,...n)}),500)}}},(()=>{const e=document.querySelector(".map"),t=function(){const t=e.querySelector(".map__card");t&&(e.removeChild(t),document.removeEventListener("keydown",n))},n=function(e){"Escape"===e.key&&(e.preventDefault(),t())};window.map={renderCard:function(t){const n=document.querySelector(".map__card");n&&n.remove(),e.appendChild(window.cards.createCard(t))},closeCard:t,getActive:function(){e.classList.remove("map--faded")},onCardEnterPress:function(e){"Enter"===e.key&&(e.preventDefault(),t())},onCardEscPress:n}})(),(()=>{const e=document.querySelector(".map__pins");window.adsDataContent=[],window.pin={renderPins:function(t){const n=document.querySelector("#pin").content.querySelector(".map__pin"),o=document.createDocumentFragment();t.forEach((function(e){o.appendChild(function(e,t){const n=e.cloneNode(!0);return n.firstChild.src=t.author.avatar,n.firstChild.alt=t.offer.title,n.style.left=t.location.x-window.util.PIN_WIDTH/2+"px",n.style.top=t.location.y-window.util.PIN_HEIGTH_ACTIVE+"px",n.addEventListener("mousedown",(function(e){e.preventDefault(),window.map.renderCard(t)})),n}(n,e))})),e.appendChild(o)},getAddress:function(e){const t=document.querySelector(".map__pin--main");document.querySelector("#address").value=Math.floor(parseInt(t.style.left,10)+window.util.PIN_WIDTH/2)+", "+Math.floor(parseInt(t.style.top,10)+e)},deletePins:function(){const t=e.querySelectorAll(".map__pin:not(.map__pin--main)");for(let e of t)e.remove()}}})(),(()=>{const e=document.querySelector("#card"),t={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},n=function(e,t){e||(t.style.display="none")};window.cards={createCard:function(o){const r=e.content.querySelector(".popup").cloneNode(!0);var i,c;return r.querySelector(".popup__title").textContent=o.offer.title,r.querySelector(".popup__text--address").textContent=o.offer.address,r.querySelector(".popup__text--price").textContent=o.offer.price+"₽/ночь",r.querySelector(".popup__type").textContent=t[o.offer.type],r.querySelector(".popup__text--time").textContent="Заезд после "+o.offer.checkin+", выезд до "+o.offer.checkout,r.querySelector(".popup__avatar").src=o.author.avatar,n(o.offer.title,r.querySelector(".popup__title")),n(o.offer.address,r.querySelector(".popup__text--address")),n(o.offer.price,r.querySelector(".popup__text--price")),n(o.offer.type,r.querySelector(".popup__type")),n(o.offer.checkin,r.querySelector(".popup__text--time")),n(o.offer.checkout,r.querySelector(".popup__text--time")),n(o.offer.features,r.querySelector(".popup__features")),n(o.offer.description,r.querySelector(".popup__description")),n(o.offer.photos,r.querySelector(".popup__photos")),n(o.author.avatar,r.querySelector(".popup__avatar")),i=r.querySelector(".popup__features"),c=o.offer.features,i.innerHTML="",c.forEach((function(e){const t=document.createElement("li");t.classList.add("popup__feature"),t.classList.add("popup__feature--"+e),i.appendChild(t)})),function(e,t){e.innerHTML="",t.forEach((function(t){const n=document.createElement("img");n.classList.add("popup__photo"),n.setAttribute("width","45"),n.setAttribute("height","40"),n.src=t,e.appendChild(n)}))}(r.querySelector(".popup__photos"),o.offer.photos),((e,t,n)=>{e.textContent=t+" комнаты для "+n+" гостей",1===t&&1===n?e.textContent=t+" комната для "+n+" гостя":1===t?e.textContent=t+" комната для "+n+" гостей":5===t&&1===n?e.textContent=t+" комнат для "+n+" гостя":(5===t||0===t&&0===n)&&(e.textContent=t+" комнат для "+n+" гостей")})(r.querySelector(".popup__text--capacity"),o.offer.rooms,o.offer.guests),r.querySelector(".popup__close").addEventListener("click",(function(){window.map.closeCard()})),r.querySelector(".popup__close").addEventListener("keydown",window.map.onCardEnterPress),document.addEventListener("keydown",window.map.onCardEscPress),r}}})(),(()=>{const e=document.querySelector(".map__filters"),t=e.querySelectorAll(".map__filter"),n=e.querySelector(".map__features"),o=e.querySelector("#housing-type"),r=e.querySelector("#housing-price"),i=e.querySelector("#housing-rooms"),c=e.querySelector("#housing-guests"),u=document.querySelector(".map__filters-container"),d=function(e){return e.filter((function(e){return function(e){return"any"===o.value||o.value===e.offer.type}(e)&&function(e){return"any"===r.value||"low"===r.value&&e.offer.price<1e4||"middle"===r.value&&e.offer.price>=1e4&&e.offer.price<=5e4||"high"===r.value&&e.offer.price>5e4}(e)&&function(e){return"any"===i.value||+i.value===e.offer.rooms}(e)&&function(e){return"any"===c.value||+c.value===e.offer.guests}(e)&&function(e){const t=n.querySelectorAll(".map__checkbox:checked");if(0===t.length)return!0;let o=!0;return t.forEach((function(t){e.offer.features.includes(t.value)||(o=!1)})),o}(e)})).slice(0,5)},a=function(){window.pin.deletePins(),window.map.closeCard(),window.pin.renderPins(d(window.dataAds))};window.filter={loadData:function(e){window.dataAds=e,window.pin.renderPins(d(window.dataAds))},hideFormIfError:function(){u.style.display="none"},getDisable:function(){t.forEach((function(e){e.disabled=!0})),n.disabled=!0,e.reset(),e.removeEventListener("change",window.debounce.shake(a))},getActive:function(){t.forEach((function(e){e.disabled=!1})),n.disabled=!1,e.addEventListener("change",window.debounce.shake(a))}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".ad-form"),n=(t.querySelector(".ad-form-header"),t.querySelector("#title")),o=t.querySelector("#timein"),r=t.querySelector("#timeout"),i=document.querySelector("#room_number"),c=document.querySelector("#capacity"),u=t.querySelector("#address"),d=document.querySelector(".ad-form__submit"),a=document.getElementsByTagName("fieldset"),s=document.querySelector("#type"),l=document.querySelector("#price"),f=document.querySelector(".ad-form__reset"),p=e.querySelector(".map__pin--main"),m=document.querySelector("#success").content.querySelector(".success"),w=document.querySelector("#error").content.querySelector(".error"),v=document.querySelector(".map__pins"),y=document.createElement("button"),_=p.style.left,E=p.style.top,h=t.querySelector(".ad-form-header__preview img"),S=t.querySelector(".ad-form-header__input"),L=t.querySelector(".ad-form__input"),q=t.querySelector(".ad-form__photo"),g=["jpg","jpeg","png"],C={bungalow:"0",flat:"1000",house:"5000",palace:"10000"},k={1:[1],2:[1,2],3:[1,2,3],100:[0]};i.addEventListener("change",(function(e){var t;e.target.setCustomValidity(""),t=i.value,c.querySelectorAll("option").forEach((function(e){e.disabled=!0})),k[t].forEach((function(e){c.querySelector('option[value="'+e+'"]').disabled=!1,c.value=e}))})),d.addEventListener("click",(function(){!function(){const e=-1===k[i.value].indexOf(+c.value)?"Это количество гостей сюда не поместится":"";c.setCustomValidity(e)}()}));const I=function(e){const t=c.querySelectorAll("option");t.forEach((function(e){e.disabled=!0})),k[e].forEach((function(e){t.forEach((function(t){Number(t.value)===e&&(t.disabled=!1,t.selected=!0)}))}))};i.addEventListener("change",(function(e){I(e.target.value)}));const b=function(){const e=s.value,t=C[e];l.min=t,l.placeholder=t};s.addEventListener("change",(function(){b()})),o.addEventListener("change",(function(){r.value=o.value})),r.addEventListener("change",(function(){o.value=r.value}));const T=function(e,t){const n=e.target.files[0],o=n.name.toLowerCase();if(g.some((function(e){return o.endsWith(e)}))){const e=new FileReader;t.src="",e.addEventListener("load",(function(e){t.src=e.target.result})),e.readAsDataURL(n)}},x=function(e){T(e,h)},A=function(e){q.innerHTML="",q.appendChild(D(e))},D=function(e){const t=document.createElement("img");return t.setAttribute("height","100%"),t.setAttribute("width","100%"),t.style.borderRadius="5px",t.setAttribute("alt","Фотография объекта"),T(e,t),t};n.addEventListener("input",(function(){!function(){const e=n.value.length;e<30?n.setCustomValidity("слишком короткое название"):e>100?n.setCustomValidity("слишком длинное название"):n.setCustomValidity(""),n.reportValidity()}()}));const H=function(){for(let e=0;e<a.length;e++)a[e].disabled=!0;f.addEventListener("click",O),b()},N=function(){for(let e=0;e<a.length;e++)a[e].disabled=!1;t.addEventListener("submit",G),f.addEventListener("click",O)};u.value=Math.floor(parseInt(p.style.left,10)+window.util.PIN_WIDTH/2)+", "+Math.floor(parseInt(p.style.top,10)+window.util.PIN_HEIGTH_DISABLE);const P=function(){e.classList.add("map--faded"),t.classList.add("ad-form--disabled"),t.reset(),h.setAttribute("src","img/muffin-grey.svg"),q.innerHTML="",window.pin.deletePins(),window.map.closeCard(),p.style.left=_,p.style.top=E,H(),window.filter.getDisable(),window.pin.getAddress(window.util.PIN_HEIGTH_DISABLE)},O=function(e){e.preventDefault(),P()},M=function(e){e.button===window.util.LEFT_BUTTON_MOUSE_DOWN&&(e.preventDefault(),t.querySelector(".success").remove(),document.removeEventListener("click",M),document.removeEventListener("keydown",W))},W=function(e){e.keyCode===window.util.ESC_KEY_CODE&&(e.preventDefault(),t.querySelector(".success").remove(),document.removeEventListener("keydown",W),document.removeEventListener("click",M))},B=function(){const e=m.cloneNode(!0);P(),S.removeEventListener("change",x),L.removeEventListener("change",A),document.addEventListener("click",M),t.appendChild(e),s.removeEventListener("change",b),i.removeEventListener("change",I),f.removeEventListener("click",O),t.removeEventListener("submit",G),document.addEventListener("keydown",W)},F=function(e){const t=w.cloneNode(!0),n=t.querySelector(".error__button"),o=function(e){e.button===window.util.LEFT_BUTTON_MOUSE_DOWN&&(e.preventDefault(),v.querySelector(".error").remove(),y.removeEventListener("click",o),document.removeEventListener("click",o),document.removeEventListener("keydown",r))},r=function(e){e.keyCode===window.util.ESC_KEY_CODE&&(e.preventDefault(),v.querySelector(".error").remove(),document.removeEventListener("keydown",r),document.removeEventListener("click",o),y.removeEventListener("click",o))},i=function(){n.removeEventListener("click",i)};t.querySelector(".error__message").textContent=e,n.addEventListener("click",i),y.classList.add("error__button"),y.textContent="Закрыть",y.addEventListener("click",o),document.addEventListener("click",o),document.addEventListener("keydown",r),t.appendChild(y),v.appendChild(t)},G=function(e){e.preventDefault(),window.backend.upload(new FormData(t),B,F)};window.form={turnOff:H,turnOn:N,getActive:function(){u.value=Math.floor(parseInt(p.style.left,10)+window.util.PIN_WIDTH/2)+", "+Math.floor(parseInt(p.style.top,10)+window.util.PIN_HEIGTH_ACTIVE/2),e.classList.remove("map--faded"),t.classList.remove("ad-form--disabled"),N(),window.filter.getActive(),t.addEventListener("submit",G),f.addEventListener("click",O),b(),S.addEventListener("change",x),L.addEventListener("change",A)}}})(),(()=>{const e=function(e){const t=document.createElement("div");t.style.left=0,t.style.right=0,t.style.position="absolute",t.style="text-align: center; z-index: 300; margin: 0 auto; background-color: #cc0605; color: #ffffff",t.style.fontSize="28px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},t=function(e){window.filter.loadData(e)};window.pin.getAddress(window.util.PIN_HEIGTH_DISABLE),window.form.turnOff(),window.main={onLoadError:e,getActivePages:function(){window.pin.getAddress(window.util.PIN_HEIGTH_ACTIVE),window.form.getActive(),window.backend.load(t,e)}}})()})();